
var mainUnits = [
  {
    "department": "Sales Dept.",
    "employees": 34,
    "approvers": [
      {
        "approverName": "George Wallace",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 120.6,
            "approvals": [
              {
                "waitTime": 10,
                "value": 64000,
                "submitter": "Jason Hobart"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Gim Botright"
              },
              {
                "waitTime": 43,
                "value": 87000,
                "submitter": "Carley Stephanus"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Diana Harvest"
              },
              {
                "waitTime": 450,
                "value": 87000,
                "submitter": "Louise Drexel"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Percy Davis",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 163.83333333333334,
            "approvals": [
              {
                "waitTime": 10,
                "value": 2900,
                "submitter": "Cynthia Hope"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Daniel Grouchko"
              },
              {
                "waitTime": 43,
                "value": 64000,
                "submitter": "Penelope Dribble"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 180000,
                "submitter": "Brian May"
              },
              {
                "waitTime": 450,
                "value": 52000,
                "submitter": "Frank Reilly"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Bobby McGee",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 196.66666666666666,
            "approvals": [
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320000,
                "submitter": "Steve Caper, Jr."
              }
            ]
          }
        ]
      },
      {
        "approverName": "Sam Abbasi",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 149.125,
            "approvals": [
              {
                "waitTime": 10,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 43,
                "value": 67000,
                "submitter": "Carter Dwaine"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Harper Lee"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 180000,
                "submitter": "Brian May"
              },
              {
                "waitTime": 450,
                "value": 15000,
                "submitter": "Zach Princeton"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Catarina Cota",
        "approvalTypes": [
          {
            "label": "Purchase Requests",
            "average": 104.4,
            "approvals": [
              {
                "waitTime": 10,
                "value": 5000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 43,
                "value": 33000,
                "submitter": "John Flanagan"
              },
              {
                "waitTime": 80,
                "value": 18000,
                "submitter": "Andrew Horton"
              },
              {
                "waitTime": 90,
                "value": 50000,
                "submitter": "Cynthia Van-Leer"
              },
              {
                "waitTime": 95,
                "value": 12000,
                "submitter": "Theofilia Drapes"
              },
              {
                "waitTime": 116,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320000,
                "submitter": "Steve Caper, Jr."
              }
            ]
          }
        ]
      },
      {
        "approverName": "Esmail Mazza",
        "approvalTypes": [
          {
            "label": "Vendor On-boarding",
            "average": 210,
            "approvals": [
              {
                "waitTime": 170,
                "value": 30000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 220,
                "value": 60000,
                "submitter": "Pete Donovan"
              },
              {
                "waitTime": 240,
                "value": 36000,
                "submitter": "Larry Quench"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "department": "Supply Chain Dept.",
    "employees": 62,
    "approvers": [
      {
        "approverName": "Sam Katwan",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 120.6,
            "approvals": [
              {
                "waitTime": 10,
                "value": 5000,
                "submitter": "Alex White"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Dora Van-Halen"
              },
              {
                "waitTime": 43,
                "value": 64000,
                "submitter": "Russ King"
              },
              {
                "waitTime": 80,
                "value": 5000,
                "submitter": "Jennifer Pascal"
              },
              {
                "waitTime": 450,
                "value": 5400,
                "submitter": "Xhi Choo Ohn"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Sammy Davis",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 163.83333333333334,
            "approvals": [
              {
                "waitTime": 10,
                "value": 9500,
                "submitter": "Derek Holmes"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 43,
                "value": 9500,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 180000,
                "submitter": "Brian May"
              },
              {
                "waitTime": 450,
                "value": 14000,
                "submitter": "Ning Hou"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Bobby McGee",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 196.66666666666666,
            "approvals": [
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320000,
                "submitter": "Steve Caper, Jr."
              }
            ]
          }
        ]
      },
      {
        "approverName": "Rudy Jewels",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 149.125,
            "approvals": [
              {
                "waitTime": 10,
                "value": 14000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 43,
                "value": 14000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 180000,
                "submitter": "Brian May"
              },
              {
                "waitTime": 450,
                "value": 64000,
                "submitter": "Frank Reilly"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Katie Denver",
        "approvalTypes": [
          {
            "label": "Purchase Requests",
            "average": 104.4,
            "approvals": [
              {
                "waitTime": 10,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 43,
                "value": 33000,
                "submitter": "John Flanagan"
              },
              {
                "waitTime": 80,
                "value": 18000,
                "submitter": "Andrew Horton"
              },
              {
                "waitTime": 90,
                "value": 50000,
                "submitter": "Cynthia Van-Leer"
              },
              {
                "waitTime": 95,
                "value": 12000,
                "submitter": "Theofilia Drapes"
              },
              {
                "waitTime": 116,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320000,
                "submitter": "Steve Caper, Jr."
              }
            ]
          }
        ]
      },
      {
        "approverName": "Pierre Rocheford",
        "approvalTypes": [
          {
            "label": "Vendor On-boarding",
            "average": 210,
            "approvals": [
              {
                "waitTime": 170,
                "value": 30000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 220,
                "value": 60000,
                "submitter": "Pete Donovan"
              },
              {
                "waitTime": 240,
                "value": 36000,
                "submitter": "Larry Quench"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "department": "Customer Success Dept.",
    "employees": 45,
    "approvers": [
      {
        "approverName": "Linda Grey",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 120.6,
            "approvals": [
              {
                "waitTime": 10,
                "value": 70000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 43,
                "value": 70000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 80,
                "value": 70000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 450,
                "value": 42000,
                "submitter": "Ning Hou"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Sammy Davis",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 163.83333333333334,
            "approvals": [
              {
                "waitTime": 10,
                "value": 42000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 43,
                "value": 42000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320,
                "submitter": "Brian May"
              },
              {
                "waitTime": 450,
                "value": 92000,
                "submitter": "Frank Reilly"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Tim Pence",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 149.125,
            "approvals": [
              {
                "waitTime": 10,
                "value": 92000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 43,
                "value": 150000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 3200,
                "submitter": "Don Mclean"
              },
              {
                "waitTime": 450,
                "value": 64000,
                "submitter": "Frank Reilly"
              }
            ]
          }
        ]
      },
      {
        "approverName": "Don Flanagan",
        "approvalTypes": [
          {
            "label": "Purchase Requests",
            "average": 104.4,
            "approvals": [
              {
                "waitTime": 10,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 43,
                "value": 33000,
                "submitter": "John Flanagan"
              },
              {
                "waitTime": 80,
                "value": 18000,
                "submitter": "Andrew Horton"
              },
              {
                "waitTime": 90,
                "value": 50000,
                "submitter": "Cynthia Van-Leer"
              },
              {
                "waitTime": 95,
                "value": 12000,
                "submitter": "Theofilia Drapes"
              },
              {
                "waitTime": 116,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320000,
                "submitter": "Steve Caper, Jr."
              }
            ]
          }
        ]
      },
      {
        "approverName": "Terence Bing",
        "approvalTypes": [
          {
            "label": "Vendor On-boarding",
            "average": 210,
            "approvals": [
              {
                "waitTime": 170,
                "value": 30000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 220,
                "value": 60000,
                "submitter": "Pete Donovan"
              },
              {
                "waitTime": 240,
                "value": 36000,
                "submitter": "Larry Quench"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "department": "R&D Dept.",
    "employees": 54,
    "approvers": [
      {
        "approverName": "Billie Hollins",
        "approvalTypes": [
          {
            "label": "Purchase Orders",
            "average": 142.77777777777777,
            "approvals": [
              {
                "waitTime": 10,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 43,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 92,
                "value": 180000,
                "submitter": "Don Mclean"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 180,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 280,
                "value": 320000,
                "submitter": "Don Mclean"
              },
              {
                "waitTime": 450,
                "value": 64000,
                "submitter": "Frank Reilly"
              }
            ]
          },
          {
            "label": "Expenses",
            "average": 190.88888888888889,
            "averageLabel": "5.2 Days",
            "approvals": [
              {
                "waitTime": 15,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 33,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 50,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 120,
                "value": 80000,
                "submitter": "Steve Caper, Jr."
              },
              {
                "waitTime": 160,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 340,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 400,
                "value": 320000,
                "submitter": "Don Mclean"
              },
              {
                "waitTime": 520,
                "value": 64000,
                "submitter": "Frank Reilly"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "department": "Marketing Dept.",
    "employees": 26,
    "approvers": [
      {
        "approverName": "Perikilis Nazario",
        "approvalTypes": [
          {
            "label": "Campaign Invoices",
            "average": 80.33333333333333,
            "approvals": [
              {
                "waitTime": 10,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 20,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 92,
                "value": 80000,
                "submitter": "Roger Crabs"
              },
              {
                "waitTime": 130,
                "value": 8000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 150,
                "value": 64000,
                "submitter": "Ning Hou"
              }
            ]
          },
          {
            "label": "Expenses",
            "average": 135.625,
            "approvals": [
              {
                "waitTime": 15,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 33,
                "value": 32000,
                "submitter": "Linda Packer"
              },
              {
                "waitTime": 47,
                "value": 32000,
                "submitter": "Chelsia Hu"
              },
              {
                "waitTime": 50,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 80,
                "value": 64000,
                "submitter": "Frank Reilly"
              },
              {
                "waitTime": 120,
                "value": 320000,
                "submitter": "Roger Crabs"
              },
              {
                "waitTime": 340,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 400,
                "value": 55000,
                "submitter": "Steve Caper, Jr."
              }
            ]
          },
          {
            "label": "Vendor Payment",
            "average": 318,
            "approvals": [
              {
                "waitTime": 420,
                "value": 64000,
                "submitter": "Ning Hou"
              },
              {
                "waitTime": 350,
                "value": 320000,
                "submitter": "Roger Crabs"
              },
              {
                "waitTime": 370,
                "value": 120000,
                "submitter": "Rick Smith"
              },
              {
                "waitTime": 150,
                "value": 10000,
                "submitter": "Jeremy Lambeth"
              },
              {
                "waitTime": 300,
                "value": 55000,
                "submitter": "Roger Crabs"
              }
            ]
          }
        ]
      }
    ]
  }
];

function calculateTotalValues(originalData) {
  originalData.forEach(function(unit) {
    unit.approvers.forEach(function(approver) {
      approver.approverTotalValue = approver.approvalTypes.reduce(function(b, approvalType) {
        return b + approvalType.approvals.reduce(function(c, approval) {
          return c + approval.value;
        }, 0);
      }, 0);
    });
  });

  originalData.forEach(function(unit) {
    unit.unitTotalValue = unit.approvers.reduce(function(c, approver) {
      return c + approver.approverTotalValue;
    }, 0);
  });

  originalData.forEach(function(unit) {
    var approvalCount = unit.approvers.reduce(function(c, approver) {
      return c + approver.approvalTypes.reduce(function(c, approvalType) {
        return c + approvalType.approvals.length;
      }, 0);
    }, 0);

    unit.unitLabel = unit.department + " " + unit.employees + " employees " + approvalCount + " approvals";
  });

  originalData.forEach(function(unit) {
    unit.approvers.forEach(function(approver) {
      approver.approvalTypes.forEach(function(approvalType) {
        approvalType.average = approvalType.approvals.reduce(function(c, approval) {
            return c + approval.waitTime;
          }, 0) / approvalType.approvals.length;
      });
    });
  });

}

function filterDataByCriteria(criteria) {
  // criteria {totalValueMin, totalValueMax, waitTimeMin, waitTimeMax, typesFilter}

  // hide approvals that are outside wait time range
  mainUnits.forEach(function(unit) {
    unit.approvers.forEach(function(approver) {
      approver.approvalTypes.forEach(function(approvalType) {
        approvalType.approvals.forEach(function(approval) {
          approval.hidden = false;
          if (criteria.waitTimeMin == null && criteria.amountMin == null)
            approval.hidden = false;
          else {
            if (criteria.waitTimeMin !== null) approval.hidden = !(approval.waitTime >= criteria.waitTimeMin && approval.waitTime <= criteria.waitTimeMax);
            if (!approval.hidden && criteria.amountMin !== null) approval.hidden = !(approval.value >= criteria.amountMin && approval.value <= criteria.amountMax);
          }
        })
      })
    })
  });

  // hide irrelevant approvals types
  mainUnits.forEach(function(unit) {
    unit.approvers.forEach(function(approver) {
      approver.approvalTypes.forEach(function(t) {
        t.hidden = !(criteria.typesFilter.indexOf(t.label) >= 0) ||
          t.approvals.every(function(approval) {return approval.hidden});
      });
    })
  });

  // hide irrelevant approvers based on total value
  if (criteria.totalValueMin !== null) {
    mainUnits.forEach(function (unit) {
      unit.approvers.forEach(function(approver) {
        var validValue = criteria.totalValueMin == null || (approver.approverTotalValue >= criteria.totalValueMin && approver.approverTotalValue <= criteria.totalValueMax);
        var noValidApprovalTypes = approver.approvalTypes.every(function(t) {return t.hidden});
        approver.hidden = !validValue || noValidApprovalTypes;
      });
    })
  }

  // hide irrelevant units
  mainUnits.forEach(function (unit) {
    unit.hidden = !unit.selected && unit.approvers.every(function(approver) {return approver.hidden});
  });

  return mainUnits;
}

function filterApproverDataByCriteria(approver, criteria) {

  approver.approvalTypes.forEach(function(approvalType) {
    approvalType.approvals.forEach(function(approval) {
      approval.hidden = !(criteria.waitTimeMin == null || (approval.waitTime >= criteria.waitTimeMin && approval.waitTime <= criteria.waitTimeMax));
    })
  });

  approver.approvalTypes.forEach(function(t) {
    t.hidden = !(criteria.typesFilter.indexOf(t.label) >= 0) ||
      t.approvals.every(function(approval) {return approval.hidden});
  });

  return approver;

}

function getAllVisibleApprovals() {
  var approvals = [];
  mainUnits.forEach(function(unit) {
    unit.approvers.forEach(function(approver) {
      approver.approvalTypes.forEach(function(approvalType) {
        approvals = approvals.concat(filterNonHidden(approvalType.approvals));
      });
    });
  });
  return approvals.sort(function(a,b) {
    if (a.value > b.value) return -1;
    if (b.value > a.value) return 1;
    return 0;
  });
}

function getApproverVisibleApprovals(approver) {
  var approvals = [];
  approver.approvalTypes.forEach(function(approvalType) {
    approvals = approvals.concat(filterNonHidden(approvalType.approvals));
  });
  return approvals.sort(function(a,b) {
    if (a.value > b.value) return -1;
    if (b.value > a.value) return 1;
    return 0;
  });
}